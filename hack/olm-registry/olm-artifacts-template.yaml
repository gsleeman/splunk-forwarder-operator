apiVersion: v1
kind: Template
metadata:
  name: olm-artifacts-template

parameters:
- name: REGISTRY_IMG
  required: true
- name: CHANNEL
  value: staging
- name: IMAGE_TAG
  value: latest
- name: REPO_DIGEST
  required: true
- name: ALERTS_SKIP_LEGALENTITY_IDS
  value: '["none"]'
- name: OPERATOR_NAME
  value: splunk-forwarder-operator
  required: true

objects:
- apiVersion: hive.openshift.io/v1
  kind: SelectorSyncSet
  metadata:
    annotations:
      component-display-name: Splunk Forwarder Operator
      component-name: ${OPERATOR_NAME}
      telemeter-query: csv_succeeded{_id="$CLUSTER_ID",name=~"${OPERATOR_NAME}.*",exported_namespace=~"openshift-.*",namespace="openshift-operator-lifecycle-manager"} == 1
    name: splunk-forwarder-operator-sss
    namespace: splunk-forwarder-operator
  spec:
    clusterDeploymentSelector:
      matchLabels:
        api.openshift.com/managed: "true"
    resourceApplyMode: Sync
    resources:
    - apiVersion: v1
      kind: Namespace
      metadata:
        name: openshift-splunk-forwarder-operator
        annotations:
          openshift.io/node-selector: ''
    - apiVersion: v1
      kind: Namespace
      metadata:
        name: openshift-security
        annotations:
          openshift.io/node-selector: ''
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        creationTimestamp: null
        name: openshift-splunk-forwarder-operator
      rules:
      - apiGroups:
        - ""
        resources:
        - pods
        - services
        - endpoints
        - persistentvolumeclaims
        - events
        - configmaps
        - secrets
        verbs:
        - '*'
      - apiGroups:
        - apps
        resources:
        - deployments
        - daemonsets
        - replicasets
        - statefulsets
        verbs:
        - '*'
      - apiGroups:
        - monitoring.coreos.com
        resources:
        - servicemonitors
        verbs:
        - get
        - create
      - apiGroups:
        - apps
        resourceNames:
        - splunk-forwarder-operator
        resources:
        - deployments/finalizers
        verbs:
        - update
      - apiGroups:
        - splunkforwarder.managed.openshift.io
        resources:
        - '*'
        verbs:
        - '*'

    - apiVersion: security.openshift.io/v1
      metadata:
        name: splunkforwarder
      allowHostDirVolumePlugin: true
      allowHostIPC: false
      allowHostNetwork: false
      allowHostPID: false
      allowHostPorts: false
      allowPrivilegeEscalation: true
      allowPrivilegedContainer: true
      allowedCapabilities:
      - '*'
      allowedUnsafeSysctls:
      - '*'
      defaultAddCapabilities: null
      fsGroup:
        type: RunAsAny
      kind: SecurityContextConstraints
      priority: null
      readOnlyRootFilesystem: false
      requiredDropCapabilities: null
      runAsUser:
        type: RunAsAny
      seLinuxContext:
        type: RunAsAny
      seccompProfiles:
      - '*'
      supplementalGroups:
        type: RunAsAny
      users:
      - system:serviceaccount:openshift-security:default
      volumes:
      - '*'
    - kind: ClusterRoleBinding
      apiVersion: rbac.authorization.k8s.io/v1
      metadata:
        name: splunk-forwarder-operator
      subjects:
      - kind: ServiceAccount
        name: default
        namespace: openshift-splunk-forwarder-operator
      roleRef:
        kind: ClusterRole
        name: openshift-splunk-forwarder-operator
        apiGroup: rbac.authorization.k8s.io
    - apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        name: splunk-forwarder-operator-catalog
        namespace: openshift-splunk-forwarder-operator
      spec:
        sourceType: grpc
        image: ${REPO_DIGEST}
        displayName: splunk-forwarder-operator Registry
        publisher: SRE
        affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                - key: node-role.kubernetes.io/infra
                  operator: Exists
              weight: 1
        tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            operator: Exists

    - apiVersion: operators.coreos.com/v1alpha2
      kind: OperatorGroup
      metadata:
        name: splunk-forwarder-operator-og
        namespace: openshift-splunk-forwarder-operator
      spec:
        targetNamespaces:
        - openshift-splunk-forwarder-operator

    - apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: openshift-splunk-forwarder-operator
        namespace: openshift-splunk-forwarder-operator
      spec:
        channel: ${CHANNEL}
        name: splunk-forwarder-operator
        source: splunk-forwarder-operator-catalog
        sourceNamespace: openshift-splunk-forwarder-operator

    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        creationTimestamp: null
        name: splunk-forwarder-operator
      rules:
      - apiGroups:
        - ""
        resources:
        - secrets
        verbs:
        - list
        - get
      - apiGroups:
        - ""
        resources:
        - configmaps
        verbs:
        - list
        - get
        - update
        - create
        - delete
      - apiGroups:
        - apps
        resources:
        - daemonsets
        verbs:
        - get
        - create
        - list
        - update
        - delete
      - apiGroups:
        - splunkforwarders.splunkforwarder.managed.openshift.io
        resources:
        - '*'
        verbs:
        - '*'
      - apiGroups:
        - config.openshift.io
        resources:
        - infrastructures
        verbs:
        - get
        - list
        - watch

    - apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: splunk-forwarder-operator
        namespace: openshift-splunk-forwarder-operator


    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: splunk-forwarder-operator-clusterrolebinding
      subjects:
      - kind: ServiceAccount
        name: splunk-forwarder-operator
        namespace: openshift-splunk-forwarder-operator
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: splunk-forwarder-operator

    secretMappings:
    - sourceRef:
        name: splunk-auth
        namespace: splunk-forwarder-operator
      targetRef:
        name: splunk-auth
        namespace: openshift-security

    secretReferences:
    - source:
        name: splunk-auth
        namespace: splunk-forwarder-operator
      target:
        name: splunk-auth
        namespace: openshift-security

- apiVersion: hive.openshift.io/v1
  kind: SelectorSyncSet
  metadata:
    name: splunk-forwarder-operator-cr-sss
    namespace: splunk-forwarder-operator
  spec:
    clusterDeploymentSelector:
      matchExpressions:
        - { key: api.openshift.com/managed, operator: In, values: ["true"] }
        - { key: api.openshift.com/environment, operator: In, values: ["production"] }
        - { key: api.openshift.com/noalerts, operator: NotIn, values: ["true"] }
        - { key: ext-managed.openshift.io/noalerts, operator: NotIn, values: ["true"] }
        - key: api.openshift.com/legal-entity-id
          operator: NotIn
          values: ${{ALERTS_SKIP_LEGALENTITY_IDS}}
        - { key: hive.openshift.io/cluster-region, operator: NotIn, values: ["cn-north-1", "cn-northwest-1"] }
    resourceApplyMode: Sync
    resources:
    - apiVersion: splunkforwarder.managed.openshift.io/v1alpha1
      kind: SplunkForwarder
      metadata:
        name: splunkforwarder
        namespace: openshift-security
      spec:
        image: quay.io/app-sre/splunk-forwarder
        imageDigest: sha256:2452a3f01e840661ee1194777ed5a9185ceaaa9ec7329ed364fa2f02be22a701
        heavyForwarderImage: quay.io/app-sre/splunk-heavyforwarder
        heavyForwarderDigest: sha256:49b40c2c5d79913efb7eff9f3bf9c7348e322f619df10173e551b2596913d52a
        heavyForwarderSelector: infra
        useHeavyForwarder: true
        splunkLicenseAccepted: true
        filters:
        - name: ignore_serviceaccount_users
          filter: '"user":{"username":"(?:system:serviceaccount:[^"]+)".*"userAgent":"(?:(?![^"]*(Mozilla|oc|Wget|curl|kubectl(?:\.exe)?)/)[^"]+)'
        - name: ignore_system_node_users
          filter: '"user":{"username":"system:node:[^"]+"'
        - name: ignore_chatty_system_users
          filter: '"user":{"username":"system:(?:kube-(?:controller-manager|scheduler|apiserver-cert-syncer)|apiserver|aggregator)"'
        splunkInputs:
        - path: /host/var/log/openshift-apiserver/audit.log
          index: openshift_managed_audit
          whiteList: \.log$
          sourceType: _json
        - path: /host/var/log/kube-apiserver/audit.log
          index: openshift_managed_audit
          whiteList: \.log$
          sourceType: _json
        - path: /host/var/log/oauth-apiserver/audit.log
          index: openshift_managed_audit
          whiteList: \.log$
          sourceType: _json
        - path: /host/var/log/pods/*_ip-*-*-*-*ec2internal-debug_*/container-*/*.log
          index: openshift_managed_debug_node
          whiteList: \.log$
          sourceType: openshift:debug
        - path: /host/var/log/openshift_managed_pod_creation.log
          index: openshift_managed_pod_creation
          whiteList: \.log$
          sourceType: _json
        - path: /host/var/log/openshift_managed_malware_scan.log
          index: openshift_managed_malware_scan
          whiteList: \.log$
          sourceType: _json
        - path: /host/var/lib/kubelet/pods/*/volumes/kubernetes.io~*/pvc-*/backplane-audit.log
          index: openshift_managed_backplane_prod
          sourceType: _json
          whiteList: \.log$

- apiVersion: hive.openshift.io/v1
  kind: SelectorSyncSet
  metadata:
    name: splunk-forwarder-operator-cr-stg-sss
    namespace: splunk-forwarder-operator
  spec:
    clusterDeploymentSelector:
      matchExpressions:
        - { key: api.openshift.com/managed, operator: In, values: ["true"] }
        - { key: api.openshift.com/environment, operator: In, values: ["staging"] }
        - { key: api.openshift.com/noalerts, operator: NotIn, values: ["true"] }
        - { key: ext-managed.openshift.io/noalerts, operator: NotIn, values: ["true"] }
        - { key: hive.openshift.io/cluster-region, operator: NotIn, values: ["cn-north-1", "cn-northwest-1"] }
    resourceApplyMode: Sync
    resources:
    - apiVersion: splunkforwarder.managed.openshift.io/v1alpha1
      kind: SplunkForwarder
      metadata:
        name: splunkforwarder
        namespace: openshift-security
      spec:
        image: quay.io/gsleeman/splunk-forwarder
        imageDigest: sha256:94f19937896b9b3b5f2cada75295e850e4cbebd5ac9ea0803aa33dc47077503a
        heavyForwarderImage: quay.io/app-sre/splunk-heavyforwarder
        heavyForwarderDigest: sha256:49b40c2c5d79913efb7eff9f3bf9c7348e322f619df10173e551b2596913d52a
        heavyForwarderSelector: infra
        useHeavyForwarder: true
        splunkLicenseAccepted: true
        splunkInputs:
        - path: /host/var/log/pods/*_ip-*-*-*-*ec2internal-debug_*/container-*/*.log
          index: openshift_managed_debug_node
          whiteList: \.log$
          sourceType: openshift:debug
        auditPolicy:
          index: openshift_managed_audit_stage
          rules:
          # metrics for policy rules include the rule number (starting at 1)
          # 1. drop common non-resource read requests (~50k/day)
          - level: None
            nonResourceURLs:
            - /
            - /api*
            - /healthz*
            - /livez*
            - /openapi/v2*
            - /readyz*
            - /version
            - /.well-known*
            verbs:
            - get
            - head
            - options
          # 2. drop leases, tokenreviews, subjectaccessreviews (~500k/day)
          - level: None
            resources:
            - group: coordination.k8s.io
              resources: ['leases']
            - group: authentication.k8s.io
              resources: ['tokenreviews']
            - group: oauth.openshift.io
              resources: ['tokenreviews']
            - group: authorization.k8s.io
              resources:
              - subjectaccessreviews
              - selfsubjectaccessreviews
          # 3. reduce events with sensitive content to metadata
          - level: Metadata
            resources:
            - group: oauth.openshift.io
              resources: ['oauthclients']
            - group: image.openshift.io
              resources: ['imagestreams/secrets']
            verbs:
            - create
            - update
            - patch
            - delete
            - deletecollection
          # 4. forward events from key namespaces
          - level: Request
            resources:
            - group: events.k8s.io
              resources: ['events']
            verbs: ['create']
            namespaces:
            - default
            - openshift-etcd
            - openshift-apiserver
            - openshift-kube-apiserver
          # 5. drop remaining events
          - level: None
            resources:
            - group: events.k8s.io
              resources: ['events']
          # 6. always forward system:admin activity
          - level: Request
            users: ['system:admin']
          # 7. drop job events initiated from cronjob controller
          - level: None
            users: ['system:serviceaccount:kube-system:cronjob-controller']
            resources:
            - group: 'batch'
              resources: ['jobs']
          # 8. exclude backplane cronjob serviceaccounts
          - level: None
            users:
            - system:serviceaccount:openshift-backplane:osd-delete-backplane-serviceaccounts
            - system:serviceaccount:openshift-backplane-srep:osd-delete-ownerrefs-serviceaccounts
            namespaces: ['openshift-backplane-srep','openshift-backplane']
          # 9. forward all other backplane serviceaccount events
          - level: Request
            userGroups: ['system:serviceaccounts:openshift-backplane-*']
          # 10. drop control plane reads (~500k/day)
          - level: None
            users:
            - system:apiserver
            - system:kube-apiserver
            - system:kube-scheduler
            - system:kube-controller-manager
            verbs:
            - get
            - head
            - list
            - watch
          # 11. drop node and openshift-internal sa reads (~5M/day)
          - level: None
            userGroups:
            - system:nodes
            - system:serviceaccounts:kube-*
            - system:serviceaccounts:openshift-*
            verbs:
            - get
            - list
            - watch
          # 12. exclude node pod bindings and tokenrequests
          - level: None
            userGroups: ['system:nodes']
            resources:
            - resources: ['serviceaccounts/token','pods/binding']
            verbs: ['create']
          # 13. exclude control plane pod bindings and tokenrequests
          - level: None
            users:
            - system:kube-controller-manager
            - system:kube-scheduler
            resources:
            - resources: ['serviceaccounts/token','pods/binding']
            verbs: ['create']
          # 14. drop sre-build-test and sre-pruning activity (~6k/day)
          - level: None
            namespaces:
            - openshift-sre-pruning
            - openshift-build-test-*
          # 15. drop openshift-marketplace pod events (~1.5k/day)
          - level: None
            resources:
            - resources: ['pods']
            namespaces: ['openshift-marketplace']
          # 16. reduce pod delete events to metadata (data is in create)
          - level: Metadata
            resources:
            - resources: ['pods']
            verbs: ['delete']
          # 17. forward pod events and other CRs we want to track
          - level: Request
            resources:
            - resources:
              - pods
            - group: compliance.openshift.io
              resources:
              - compliancecheckresults
            - group: secscan.quay.redhat.com
              resources:
              - imagemanifestvulns
            verbs:
            - create
            - update
            - patch
            - delete
            - deletecollection
          # 18. drop noisy system status updates (~115k/day)
          - level: None
            userGroups:
            - system:nodes
            - system:serviceaccounts
            - system:masters
            resources:
            - resources: ['*/status']
            - group: apps
              resources: ['*/status']
            - group: batch
              resources: ['*/status']
            - group: quota.openshift.io
              resources: ['clusterresourcequotas/status']
            - group: managed.openshift.io
              resources: ['subjectpermissions/status']
            - group: apiserver.openshift.io
              resources: ['apirequestcounts/*','apirequestcounts']
            - group: controlplane.operator.openshift.io
              resources: ['podnetworkconnectivitychecks/status']
            - group: velero.io
              resources: ['backups','backupstoragelocations/status']
            verbs: ['create','update','patch']
          # 19. drop olm no-op updates (~30k/day)
          - level: None
            users: ['system:serviceaccount:openshift-operator-lifecycle-manager:olm-operator-serviceaccount']
            resources:
            - resources: ['namespaces']
            - group: apps
              resources: ['deployments']
            - group: operators.coreos.com
              resources: ['clusterserviceversions']
            - group: operators.coreos.com
              resources: ['*/status','operatorgroups']
            - group: rbac.authorization.k8s.io
              resources: ['clusterroles']
            verbs: ['update','patch']
          # 20. drop cmo no-op secret updates (~2k/day)
          - level: None
            users:
            - system:serviceaccount:openshift-monitoring:cluster-monitoring-operator
            - system:serviceaccount:openshift-monitoring:prometheus-operator
            resources:
            - resources: ['secrets']
            namespaces: ['openshift-*']
          # 21. service-ca no-op updates (~2k/day)
          - level: None
            users:
            - system:serviceaccount:openshift-service-ca:service-ca
            resources:
            - group: admissionregistration.k8s.io
              resources: ['validatingwebhookconfigurations']
            - resources: ['secrets']
            verbs: ['update','patch']
          # 22. drop console no-op route updates (~2k/day)
          - level: None
            users: ['system:serviceaccount:openshift-console-operator:console-operator']
            resources:
            - group: route.openshift.io
              resources: ['routes']
              resourceNames: ['console','downloads']
            namespaces: ['openshift-console']
            verbs: ['update']
          # 23. drop clusterrole rbac aggregation updates (2.5k/day)
          - level: None
            users: ['system:serviceaccount:kube-system:clusterrole-aggregation-controller']
            resources:
            - group: rbac.authorization.k8s.io
              resources: ['clusterroles']
            verbs: ['update','patch']
          # 24. drop cvo no-op imagestream updates (2.5k/day)
          - level: None
            users: ['system:serviceaccount:openshift-cluster-version:default']
            resources:
            - group: image.openshift.io
              resources: ['imagestreams']
            verbs: ['update']
          # 25. drop control plane endpoint updates (3k/day, data already captured in pod status)
          - level: None
            resources:
            - group: discovery.k8s.io
              resources: ['endpointslices']
            - resources: ['endpoints']
          # 26. reduce clusterserviceversions create & delete to metadata
          - level: Metadata
            resources:
            - group: operators.coreos.com
              resources: ['clusterserviceversions']
            verbs: ['create','delete','deletecollection']
          # 27. drop network-operator no-op namespace updates (1k/day)
          - level: None
            users: ['system:serviceaccount:openshift-network-operator:default']
            resources:
            - resources: ['namespaces']
            verbs: ['patch','update']
